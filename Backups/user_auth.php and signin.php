signin.php
<?php session_set_cookie_params(['httponly'=>true,'secure'=>true,'samesite'=>'Strict']);session_start();header("X-Frame-Options: DENY");$errorMessage=$_SESSION['error_message']??'';$successMessage=$_SESSION['success_message']??'';unset($_SESSION['error_message'],$_SESSION['success_message']);if(!isset($_SESSION['csrf_token'])){$_SESSION['csrf_token']=bin2hex(random_bytes(32));}?>
<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet"/><title>KidsGrow - Login</title><script async src="https://www.googletagmanager.com/gtag/js?id=G-4MHDP643CV"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js',new Date());gtag('config','G-4MHDP643CV');</script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"/><style>*{margin:0;padding:0;box-sizing:border-box;font-family:'Poppins',sans-serif}body{min-height:100vh;background:#f4f7ff;display:flex}.container{display:flex;width:100%}.left-section{flex:1;background:linear-gradient(135deg,#0061ff,#60efff);padding:40px;display:flex;flex-direction:column;justify-content:space-between;color:#fff;position:relative;overflow:hidden}.left-section::before{content:'';position:absolute;top:0;left:0;right:0;bottom:0;opacity:0.1}.brand{position:relative;z-index:1}.brand h1{font-size:24px;font-weight:600;display:flex;align-items:center;gap:10px}.brand h1 i{font-size:28px}.hero-content{position:relative;z-index:1;max-width:500px;margin:auto;text-align:center}.hero-content h2{font-size:36px;margin-bottom:20px}.hero-content p{font-size:18px;opacity:0.9;line-height:1.6}.copyright{position:relative;z-index:1;font-size:14px;opacity:0.8;text-align:center}.right-section{flex:1;display:flex;align-items:center;justify-content:center;padding:40px}.form-container{width:100%;max-width:400px;background:#fff;padding:40px;border-radius:20px;box-shadow:0 10px 30px rgba(0,0,0,0.1)}.form-header{text-align:center;margin-bottom:30px}.form-header h2{color:#333;font-size:28px;margin-bottom:10px}.form-header p{color:#666;font-size:16px}.form-group{margin-bottom:25px}.form-group label{display:block;margin-bottom:8px;color:#333;font-weight:500}.form-group input{width:100%;padding:12px 15px;border:2px solid #e1e1e1;border-radius:10px;font-size:16px;transition:all 0.3s ease}.form-group input:focus{border-color:#0061ff;outline:none;box-shadow:0 0 0 3px rgba(0,97,255,0.1)}.password-container{position:relative}.toggle-password{position:absolute;right:15px;top:50%;transform:translateY(-50%);background:none;border:none;color:#666;cursor:pointer;font-size:18px}.action-button{width:100%;padding:14px;background:#0061ff;color:#fff;border:none;border-radius:10px;font-size:16px;font-weight:600;cursor:pointer;transition:background 0.3s ease}.link-group{text-align:center;margin-top:20px}.link-group a{color:#0061ff;text-decoration:none;font-size:14px;font-weight:500;cursor:pointer}.link-group a:hover{text-decoration:underline}.popup{position:fixed;top:20px;right:20px;padding:15px 25px;border-radius:10px;color:#fff;font-size:14px;opacity:0;transform:translateY(-20px);transition:all 0.3s ease}.error-popup{background:#ff4d4d}.success-popup{background:#00c853}.popup.show{opacity:1;transform:translateY(0)}.hidden{display:none}@media screen and (max-width:768px){.container{flex-direction:column}.left-section{order:1;padding:20px;text-align:center}.right-section{order:2;padding:20px}.form-container{max-width:90%;padding:20px;margin:0 auto}.form-header h2{font-size:24px}.hero-content h2{font-size:28px}.hero-content p{font-size:16px}}</style></head><body><div class="container"><div class="left-section"><div class="brand"><h1><i class="fas fa-child"></i> KidsGrow</h1></div><div class="hero-content"><h2>Welcome to KidsGrow!</h2><p>Empowering healthy childhoods with accurate records and personalized care. Join us in safeguarding the future, one child at a time.</p></div><div class="copyright"><p>&copy; 2025 KidsGrow Educational Solutions. All Rights Reserved.</p></div></div><div class="right-section"><div class="form-container"><div id="loginSection"><div class="form-header"><h2>Sign In</h2><p>Access your KidsGrow account</p></div><form id="login-form" method="post" action="user_auth.php?no_rewrite=1"><input type="hidden" name="action" value="sign_in"><input type="hidden" name="csrf_token" id="csrf_token" value="<?php echo htmlspecialchars($_SESSION['csrf_token']);?>"><div class="form-group"><label for="email">Email Address</label><input type="email" id="email" name="email" placeholder="Enter your email" required></div><div class="form-group"><label for="password">Password</label><div class="password-container"><input type="password" id="password" name="password" placeholder="Enter your password" required><button type="button" class="toggle-password" onclick="togglePasswordVisibility()"><i class="fas fa-eye"></i></button></div></div><button type="submit" class="action-button">Sign In</button><div class="link-group"><a onclick="showSection('forgotSection')">Forgot Password?</a></div></form></div><div id="forgotSection" class="hidden"><div class="form-header"><h2>Forgot Password</h2><p>Enter your email to receive an OTP</p></div><div class="form-group"><label for="forgot-email">Email Address</label><input type="email" id="forgot-email" name="email" placeholder="Enter your email" required></div><button class="action-button" onclick="sendOTP()">Send OTP</button><div class="link-group"><a onclick="showSection('loginSection')">Back to Sign In</a></div></div><div id="otpSection" class="hidden"><div class="form-header"><h2>OTP Verification</h2><p>Enter the OTP sent to your email</p></div><div class="form-group"><label for="otp-input">OTP</label><input type="text" id="otp-input" placeholder="Enter OTP" required></div><div class="form-group"><label for="otp-email">Email Address</label><input type="email" id="otp-email" placeholder="Enter your email" readonly required></div><button class="action-button" onclick="verifyOTP()">Verify OTP</button><div class="link-group"><a onclick="showSection('forgotSection')">Back</a></div></div><div id="resetSection" class="hidden"><div class="form-header"><h2>Reset Password</h2><p>Enter your new password</p></div><div class="form-group"><label for="new-password">New Password</label><div class="password-container"><input type="password" id="new-password" placeholder="Enter new password" required><button type="button" class="toggle-password" onclick="togglePasswordVisibility('new-password',this)"><i class="fas fa-eye"></i></button></div></div><button class="action-button" onclick="resetPassword()">Reset Password</button><div class="link-group"><a onclick="showSection('loginSection')">Back to Sign In</a></div></div></div></div></div><div id="errorPopup" class="popup error-popup"><?php echo htmlspecialchars($errorMessage); ?></div><div id="successPopup" class="popup success-popup"><?php echo htmlspecialchars($successMessage); ?></div><script>document.addEventListener("DOMContentLoaded",function(){var lf=document.getElementById("login-form"),csrfToken='<?php echo $_SESSION['csrf_token'];?>';window.togglePasswordVisibility=function(i,t){var e=document.getElementById(i||"password"),n=t?t.querySelector("i"):document.querySelector(".toggle-password i");e.type==="password"?(e.type="text",n.className="fas fa-eye-slash"):(e.type="password",n.className="fas fa-eye")};window.showPopup=function(m,t){var p=document.getElementById(t==="error"?"errorPopup":"successPopup");p.textContent=m,p.classList.add("show"),setTimeout(function(){p.classList.remove("show")},3e3)};window.showSection=function(s){["loginSection","forgotSection","otpSection","resetSection"].forEach(function(id){document.getElementById(id).classList.add("hidden")}),document.getElementById(s).classList.remove("hidden")};lf.addEventListener("submit",function(e){e.preventDefault();var d=new FormData(lf);fetch("user_auth.php?no_rewrite=1",{method:"POST",body:new URLSearchParams(d)}).then(function(r){return r.json()}).then(function(data){data.success?(showPopup(data.message,"success"),window.location.href=data.role==="Parent"?"./u/dashboard.php":"dashboard.php"):showPopup(data.message,"error")}).catch(function(error){console.error("Error:",error),showPopup("An error occurred. Please try again.","error")})});lf.addEventListener("keydown",function(e){"Enter"===e.key&&(e.preventDefault(),lf.dispatchEvent(new Event("submit",{cancelable:!0})))});window.sendOTP=function(){var e=document.getElementById("forgot-email").value;if(!e)return showPopup("Please enter your email.","error"),void 0;var d=new URLSearchParams();d.append("email",e),d.append("csrf_token",csrfToken),fetch("sendotp",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:d.toString()}).then(function(r){return r.json()}).then(function(data){data.success?(showPopup(data.message,"success"),document.getElementById("otp-email").value=e,showSection("otpSection")):showPopup(data.message,"error")}).catch(function(error){console.error("Fetch Error:",error),showPopup("An error occurred. Please try again.","error")})};window.verifyOTP=function(){var e=document.getElementById("otp-email").value,t=document.getElementById("otp-input").value;if(!e||!t)return showPopup("Please enter both email and OTP.","error"),void 0;var d=new URLSearchParams();d.append("action","verify_otp"),d.append("email",e),d.append("otp",t),d.append("csrf_token",csrfToken),fetch("user_auth.php?no_rewrite=1",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:d.toString()}).then(function(r){return r.json()}).then(function(data){data.success?(showPopup(data.message,"success"),showSection("resetSection")):showPopup(data.message,"error")}).catch(function(error){console.error("Error:",error),showPopup("An error occurred. Please try again.","error")})};window.resetPassword=function(){var e=document.getElementById("new-password").value;if(!e)return showPopup("Please enter your new password.","error"),void 0;var d=new URLSearchParams();d.append("action","reset_password"),d.append("new_password",e),d.append("csrf_token",csrfToken),fetch("user_auth.php?no_rewrite=1",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:d.toString()}).then(function(r){return r.json()}).then(function(data){data.success?(showPopup(data.message,"success"),setTimeout(function(){showSection("loginSection")},3e3)):showPopup(data.message,"error")}).catch(function(error){console.error("Error:",error),showPopup("An error occurred. Please try again.","error")})};document.addEventListener("contextmenu",function(e){e.preventDefault()});document.onkeydown=function(e){return 123===e.keyCode||e.ctrlKey&&e.shiftKey&&(73===e.keyCode||74===e.keyCode)||e.ctrlKey&&e.keyCode===85?!1:!0};function refreshCSRFToken(){fetch("./csrf_token.php").then(response=>response.json()).then(data=>{if(data.error){console.warn("Session expired, reloading page...");location.reload()}else{document.getElementById("csrf_token").value=data.csrf_token;csrfToken=data.csrf_token}}).catch(error=>console.error("CSRF Token Refresh Error:",error))}setInterval(refreshCSRFToken,600000);refreshCSRFToken();});</script></body></html>


user_auth.php
<?php session_set_cookie_params(['httponly'=>true,'secure'=>true,'samesite'=>'Strict']);session_start();header('Content-Type: application/json');if(!isset($_SESSION['csrf_token'])){$_SESSION['csrf_token']=bin2hex(random_bytes(32));}if($_SERVER['REQUEST_METHOD']!=='POST'){http_response_code(405);echo json_encode(['success'=>false,'message'=>'Invalid request method.']);exit;}if(!isset($_POST['csrf_token'])||!hash_equals($_SESSION['csrf_token'],$_POST['csrf_token'])){echo json_encode(['success'=>false,'message'=>'Invalid CSRF token.']);exit;}$dsn="pgsql:host=ep-purple-sea-a1d1bece-pooler.ap-southeast-1.aws.neon.tech;port=5432;dbname=neondb;sslmode=require";$db_user="neondb_owner";$db_password="npg_39CVAQbvIlOy";try{$pdo=new PDO($dsn,$db_user,$db_password,[PDO::ATTR_ERRMODE=>PDO::ERRMODE_EXCEPTION]);}catch(PDOException $e){http_response_code(500);echo json_encode(['success'=>false,'message'=>'Database connection failed.']);exit;}function validateInput($input,$type){if(empty($input))return "$type is required";if($type==='email'&&!filter_var($input,FILTER_VALIDATE_EMAIL))return "Invalid email format";if($type==='password'&&(strlen($input)<8||!preg_match('/[A-Z]/',$input)||!preg_match('/[a-z]/',$input)||!preg_match('/[0-9]/',$input)||!preg_match('/[\W_]/',$input)))return "Password must be at least 8 characters long and include uppercase, lowercase, a number, and a special character.";return null;}$action=$_POST['action']??'';if(empty($action)){echo json_encode(['success'=>false,'message'=>'Action not specified.']);exit;}switch($action){case 'sign_in':$email=$_POST['email']??'';$password=$_POST['password']??'';$err=validateInput($email,'email');if($err){echo json_encode(['success'=>false,'message'=>$err]);exit;}if(empty($password)){echo json_encode(['success'=>false,'message'=>'Password is required.']);exit;}try{$stmt=$pdo->prepare("SELECT id,password,failed_attempts,last_failed_attempt,full_name,role FROM users WHERE email=:email");$stmt->execute([':email'=>$email]);$user=$stmt->fetch(PDO::FETCH_ASSOC);if($user){$now=time();$last_failed=strtotime($user['last_failed_attempt']);if($user['failed_attempts']>=5 && $last_failed && ($now-$last_failed)<600){$remaining=600-($now-$last_failed);$min=floor($remaining/60);$sec=$remaining % 60;echo json_encode(['success'=>false,'message'=>"Account locked. Try again in {$min} minutes and {$sec} seconds. Alternatively, reset your password via OTP."]);exit;}if(password_verify($password,$user['password'])){$pdo->prepare("UPDATE users SET failed_attempts=0,last_failed_attempt=NULL WHERE email=:email")->execute([':email'=>$email]);session_regenerate_id(true);$_SESSION['user_id']=$user['id'];$_SESSION['user_name']=$user['full_name'];$_SESSION['user_role']=$user['role'];echo json_encode(['success'=>true,'message'=>'Sign in successful','role'=>$user['role']]);}else{$new_attempts=$user['failed_attempts']+1;$pdo->prepare("UPDATE users SET failed_attempts=:count,last_failed_attempt=NOW() WHERE email=:email")->execute([':count'=>$new_attempts,':email'=>$email]);echo json_encode(['success'=>false,'message'=>'Invalid email or password.']);}}else{echo json_encode(['success'=>false,'message'=>'Invalid email or password.']);}exit;}catch(PDOException $e){http_response_code(500);echo json_encode(['success'=>false,'message'=>'An unexpected error occurred.']);exit;}break;case 'verify_otp':$email=$_POST['email']??'';$otp=$_POST['otp']??'';if(empty($email)||empty($otp)){echo json_encode(['success'=>false,'message'=>'Email and OTP are required.']);exit;}try{$stmt=$pdo->prepare("SELECT * FROM users WHERE email=:email AND otp=:otp");$stmt->execute([':email'=>$email,':otp'=>$otp]);$user=$stmt->fetch(PDO::FETCH_ASSOC);if($user){$pdo->prepare("UPDATE users SET otp=NULL,failed_attempts=0,last_failed_attempt=NULL WHERE email=:email")->execute([':email'=>$email]);$_SESSION['reset_email']=$email;echo json_encode(['success'=>true,'message'=>'OTP verified.']);}else{echo json_encode(['success'=>false,'message'=>'Invalid OTP.']);}exit;}catch(PDOException $e){http_response_code(500);echo json_encode(['success'=>false,'message'=>'An error occurred. Please try again later.']);exit;}break;case 'reset_password':if(!isset($_SESSION['reset_email'])){echo json_encode(['success'=>false,'message'=>'Unauthorized request.']);exit;}$email=$_SESSION['reset_email'];$new_password=$_POST['new_password']??'';$err=validateInput($new_password,'password');if($err){echo json_encode(['success'=>false,'message'=>$err]);exit;}try{$pdo->prepare("UPDATE users SET password=:password,failed_attempts=0,last_failed_attempt=NULL WHERE email=:email")->execute([':password'=>password_hash($new_password,PASSWORD_DEFAULT),':email'=>$email]);unset($_SESSION['reset_email']);echo json_encode(['success'=>true,'message'=>'Password has been reset successfully.']);exit;}catch(PDOException $e){http_response_code(500);echo json_encode(['success'=>false,'message'=>'An error occurred. Please try again later.']);exit;}break;default:echo json_encode(['success'=>false,'message'=>'Invalid action specified.']);exit;}?>



